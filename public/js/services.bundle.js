"use strict";(self.webpackChunkurbandocs_webapp=self.webpackChunkurbandocs_webapp||[]).push([[671],{141:(e,t,r)=>{r.d(t,{K:()=>a});var n=r(9660),i=r(1235);const a=new class{constructor(){this.cache=new Map,this.cacheTimeout=12e4,this.retryAttempts=3,this.retryDelay=1e3}async withRetry(e,t=this.retryAttempts){for(let r=0;r<t;r++)try{return await e()}catch(e){if(r===t-1)throw e;await new Promise((e=>setTimeout(e,this.retryDelay*(r+1))))}}async withCache(e,t,r=this.cacheTimeout){const n=this.cache.get(e);if(n&&Date.now()-n.timestamp<r)return n.data;const i=await t();return this.cache.set(e,{data:i,timestamp:Date.now()}),i}handleError(e,t){console.error(`API Error in ${t}:`,e);let r="Une erreur inattendue s'est produite";throw"PGRST116"===e.code?r="Aucune donnée trouvée":"42P01"===e.code?r="Service temporairement indisponible":e.message?.includes("network")&&(r="Problème de connexion réseau"),i.n.setError({message:r,code:e.code}),new Error(r)}async loadCities(){try{return await this.withCache("cities",(async()=>await this.withRetry((async()=>{const{data:e,error:t}=await n.N.from("cities").select("id, name").order("name");if(t)throw t;return e}))))}catch(e){this.handleError(e,"loadCities")}}async loadZonings(e){if(!e)throw new Error("City ID is required");try{return await this.withCache(`zonings-${e}`,(async()=>await this.withRetry((async()=>{const{data:t,error:r}=await n.N.from("zonings").select("id, name").eq("city_id",e).order("name");if(r)throw r;return t}))))}catch(e){this.handleError(e,"loadZonings")}}async loadZones(e){if(!e)throw new Error("Zoning ID is required");try{return await this.withCache(`zones-${e}`,(async()=>await this.withRetry((async()=>{const{data:t,error:r}=await n.N.from("zones").select("id, name").eq("zoning_id",e).order("name");if(r)throw r;return t}))))}catch(e){this.handleError(e,"loadZones")}}async findDocument(e,t,r){if(!e||!t)throw new Error("Zoning ID and Zone ID are required");try{return await this.withRetry((async()=>{const{data:i,error:a}=await n.N.from("documents").select("\n            id,\n            html_content,\n            pdf_storage_path,\n            source_plu_date,\n            source_plu_url,\n            zoning:zonings(name, city:cities(name)),\n            zone:zones(name)\n          ").eq("zoning_id",e).eq("zone_id",t).eq("typology_id",r).single();if(a)throw a;return i}))}catch(e){this.handleError(e,"findDocument")}}async loadCitiesWithZonings(){try{return await this.withCache("cities-with-zonings",(async()=>await this.withRetry((async()=>{const{data:e,error:t}=await n.N.from("cities").select("\n              id,\n              name,\n              zonings(id, name)\n            ").order("name");if(t)throw t;return e}))))}catch(e){this.handleError(e,"loadCitiesWithZonings")}}clearCache(e){if(e)for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}}}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QixJQUMzQnlCLEtBQUssYUFDTEMsT0FDQywwT0FVREksR0FBRyxZQUFhRSxHQUNoQkYsR0FBRyxVQUFXSSxHQUNkSixHQUFHLGNBQWVLLEdBQ2xCQyxTQUVILEdBQUlwQyxFQUFPLE1BQU1BLEVBQ2pCLE9BQU9ZLElBRVgsQ0FBRSxNQUFPWixHQUNQVixLQUFLd0IsWUFBWWQsRUFBTyxlQUMxQixDQUNGLENBR0EsMkJBQU1xQyxHQUNKLElBQ0UsYUFBYS9DLEtBQUtjLFVBQVUsdUJBQXVCb0IsZUFDcENsQyxLQUFLTSxXQUFVNEIsVUFDMUIsTUFBTSxLQUFFWixFQUFJLE1BQUVaLFNBQWdCLElBQzNCeUIsS0FBSyxVQUNMQyxPQUNDLDJGQU1EQyxNQUFNLFFBRVQsR0FBSTNCLEVBQU8sTUFBTUEsRUFDakIsT0FBT1ksTUFHYixDQUFFLE1BQU9aLEdBQ1BWLEtBQUt3QixZQUFZZCxFQUFPLHdCQUMxQixDQUNGLENBR0EsVUFBQXNDLENBQVdDLEdBQ1QsR0FBSUEsRUFDRixJQUFLLE1BQU1sQyxLQUFPZixLQUFLQyxNQUFNaUQsT0FDdkJuQyxFQUFJZSxTQUFTbUIsSUFDZmpELEtBQUtDLE1BQU1rRCxPQUFPcEMsUUFJdEJmLEtBQUtDLE1BQU1tRCxPQUVmLENBR0EsYUFBQUMsR0FDRSxNQUFPLENBQ0xDLEtBQU10RCxLQUFLQyxNQUFNcUQsS0FDakJKLEtBQU1LLE1BQU1wQixLQUFLbkMsS0FBS0MsTUFBTWlELFFBRWhDLEUiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly91cmJhbmRvY3Nfd2ViYXBwLy4vc3JjL2pzL3NlcnZpY2VzL2FwaS1zZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBFbmhhbmNlZCBBUEkgU2VydmljZVxyXG4gKiBAbW9kdWxlIGFwaS1zZXJ2aWNlXHJcbiAqIEBkZXNjcmlwdGlvbiBJbXByb3ZlZCBBUEkgc2VydmljZSB3aXRoIGNhY2hpbmcsIHJldHJ5IGxvZ2ljLCBhbmQgYmV0dGVyIGVycm9yIGhhbmRsaW5nXHJcbiAqIEB2ZXJzaW9uIDEuMC4wXHJcbiAqIEBhdXRob3IgR3JleVBhbmRhXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgc3VwYWJhc2UgfSBmcm9tIFwiLi4vc3VwYWJhc2UtY2xpZW50LmpzXCI7XHJcbmltcG9ydCB7IHN0YXRlTWFuYWdlciB9IGZyb20gXCIuLi9zdGF0ZS9zdGF0ZS1tYW5hZ2VyLmpzXCI7XHJcblxyXG5jbGFzcyBBcGlTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMuY2FjaGUgPSBuZXcgTWFwKCk7XHJcbiAgICB0aGlzLmNhY2hlVGltZW91dCA9IDIgKiA2MCAqIDEwMDA7IC8vIDIgbWludXRlc1xyXG4gICAgdGhpcy5yZXRyeUF0dGVtcHRzID0gMztcclxuICAgIHRoaXMucmV0cnlEZWxheSA9IDEwMDA7IC8vIDEgc2Vjb25kXHJcbiAgfVxyXG5cclxuICAvLyBHZW5lcmljIHJldHJ5IHdyYXBwZXJcclxuICBhc3luYyB3aXRoUmV0cnkob3BlcmF0aW9uLCBhdHRlbXB0cyA9IHRoaXMucmV0cnlBdHRlbXB0cykge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdHRlbXB0czsgaSsrKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IG9wZXJhdGlvbigpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGlmIChpID09PSBhdHRlbXB0cyAtIDEpIHRocm93IGVycm9yO1xyXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PlxyXG4gICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCB0aGlzLnJldHJ5RGVsYXkgKiAoaSArIDEpKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIENhY2hlIHdyYXBwZXJcclxuICBhc3luYyB3aXRoQ2FjaGUoa2V5LCBvcGVyYXRpb24sIHR0bCA9IHRoaXMuY2FjaGVUaW1lb3V0KSB7XHJcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChrZXkpO1xyXG4gICAgaWYgKGNhY2hlZCAmJiBEYXRlLm5vdygpIC0gY2FjaGVkLnRpbWVzdGFtcCA8IHR0bCkge1xyXG4gICAgICByZXR1cm4gY2FjaGVkLmRhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IG9wZXJhdGlvbigpO1xyXG4gICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB7IGRhdGEsIHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9KTtcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxuXHJcbiAgLy8gRW5oYW5jZWQgZXJyb3IgaGFuZGxpbmdcclxuICBoYW5kbGVFcnJvcihlcnJvciwgY29udGV4dCkge1xyXG4gICAgY29uc29sZS5lcnJvcihgQVBJIEVycm9yIGluICR7Y29udGV4dH06YCwgZXJyb3IpO1xyXG5cclxuICAgIGxldCB1c2VyTWVzc2FnZSA9IFwiVW5lIGVycmV1ciBpbmF0dGVuZHVlIHMnZXN0IHByb2R1aXRlXCI7XHJcblxyXG4gICAgaWYgKGVycm9yLmNvZGUgPT09IFwiUEdSU1QxMTZcIikge1xyXG4gICAgICB1c2VyTWVzc2FnZSA9IFwiQXVjdW5lIGRvbm7DqWUgdHJvdXbDqWVcIjtcclxuICAgIH0gZWxzZSBpZiAoZXJyb3IuY29kZSA9PT0gXCI0MlAwMVwiKSB7XHJcbiAgICAgIHVzZXJNZXNzYWdlID0gXCJTZXJ2aWNlIHRlbXBvcmFpcmVtZW50IGluZGlzcG9uaWJsZVwiO1xyXG4gICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlPy5pbmNsdWRlcyhcIm5ldHdvcmtcIikpIHtcclxuICAgICAgdXNlck1lc3NhZ2UgPSBcIlByb2Jsw6htZSBkZSBjb25uZXhpb24gcsOpc2VhdVwiO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRlTWFuYWdlci5zZXRFcnJvcih7IG1lc3NhZ2U6IHVzZXJNZXNzYWdlLCBjb2RlOiBlcnJvci5jb2RlIH0pO1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKHVzZXJNZXNzYWdlKTtcclxuICB9XHJcblxyXG4gIC8vIE9wdGltaXplZCBjaXR5IGxvYWRpbmcgd2l0aCBjYWNoaW5nXHJcbiAgYXN5bmMgbG9hZENpdGllcygpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhDYWNoZShcImNpdGllc1wiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aFJldHJ5KGFzeW5jICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgICAgIC5mcm9tKFwiY2l0aWVzXCIpXHJcbiAgICAgICAgICAgIC5zZWxlY3QoXCJpZCwgbmFtZVwiKVxyXG4gICAgICAgICAgICAub3JkZXIoXCJuYW1lXCIpO1xyXG5cclxuICAgICAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCBcImxvYWRDaXRpZXNcIik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBPcHRpbWl6ZWQgem9uaW5nIGxvYWRpbmdcclxuICBhc3luYyBsb2FkWm9uaW5ncyhjaXR5SWQpIHtcclxuICAgIGlmICghY2l0eUlkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNpdHkgSUQgaXMgcmVxdWlyZWRcIik7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aENhY2hlKGB6b25pbmdzLSR7Y2l0eUlkfWAsIGFzeW5jICgpID0+IHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy53aXRoUmV0cnkoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAgICAgLmZyb20oXCJ6b25pbmdzXCIpXHJcbiAgICAgICAgICAgIC5zZWxlY3QoXCJpZCwgbmFtZVwiKVxyXG4gICAgICAgICAgICAuZXEoXCJjaXR5X2lkXCIsIGNpdHlJZClcclxuICAgICAgICAgICAgLm9yZGVyKFwibmFtZVwiKTtcclxuXHJcbiAgICAgICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG4gICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgXCJsb2FkWm9uaW5nc1wiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIE9wdGltaXplZCB6b25lIGxvYWRpbmdcclxuICBhc3luYyBsb2FkWm9uZXMoem9uaW5nSWQpIHtcclxuICAgIGlmICghem9uaW5nSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiWm9uaW5nIElEIGlzIHJlcXVpcmVkXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhDYWNoZShgem9uZXMtJHt6b25pbmdJZH1gLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aFJldHJ5KGFzeW5jICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgICAgICAgIC5mcm9tKFwiem9uZXNcIilcclxuICAgICAgICAgICAgLnNlbGVjdChcImlkLCBuYW1lXCIpXHJcbiAgICAgICAgICAgIC5lcShcInpvbmluZ19pZFwiLCB6b25pbmdJZClcclxuICAgICAgICAgICAgLm9yZGVyKFwibmFtZVwiKTtcclxuXHJcbiAgICAgICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xyXG4gICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgXCJsb2FkWm9uZXNcIik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBFbmhhbmNlZCBkb2N1bWVudCBzZWFyY2hcclxuICBhc3luYyBmaW5kRG9jdW1lbnQoem9uaW5nSWQsIHpvbmVJZCwgdHlwb2xvZ2llSWQpIHtcclxuICAgIGlmICghem9uaW5nSWQgfHwgIXpvbmVJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJab25pbmcgSUQgYW5kIFpvbmUgSUQgYXJlIHJlcXVpcmVkXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhSZXRyeShhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgICAgICAgIC5mcm9tKFwiZG9jdW1lbnRzXCIpXHJcbiAgICAgICAgICAuc2VsZWN0KFxyXG4gICAgICAgICAgICBgXHJcbiAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICBodG1sX2NvbnRlbnQsXHJcbiAgICAgICAgICAgIHBkZl9zdG9yYWdlX3BhdGgsXHJcbiAgICAgICAgICAgIHNvdXJjZV9wbHVfZGF0ZSxcclxuICAgICAgICAgICAgc291cmNlX3BsdV91cmwsXHJcbiAgICAgICAgICAgIHpvbmluZzp6b25pbmdzKG5hbWUsIGNpdHk6Y2l0aWVzKG5hbWUpKSxcclxuICAgICAgICAgICAgem9uZTp6b25lcyhuYW1lKVxyXG4gICAgICAgICAgYFxyXG4gICAgICAgICAgKVxyXG4gICAgICAgICAgLmVxKFwiem9uaW5nX2lkXCIsIHpvbmluZ0lkKVxyXG4gICAgICAgICAgLmVxKFwiem9uZV9pZFwiLCB6b25lSWQpXHJcbiAgICAgICAgICAuZXEoXCJ0eXBvbG9neV9pZFwiLCB0eXBvbG9naWVJZClcclxuICAgICAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcclxuICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCBcImZpbmREb2N1bWVudFwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEJhdGNoIGxvYWRpbmcgZm9yIGJldHRlciBwZXJmb3JtYW5jZVxyXG4gIGFzeW5jIGxvYWRDaXRpZXNXaXRoWm9uaW5ncygpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhDYWNoZShcImNpdGllcy13aXRoLXpvbmluZ3NcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhSZXRyeShhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgICAgICAgICAuZnJvbShcImNpdGllc1wiKVxyXG4gICAgICAgICAgICAuc2VsZWN0KFxyXG4gICAgICAgICAgICAgIGBcclxuICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICBuYW1lLFxyXG4gICAgICAgICAgICAgIHpvbmluZ3MoaWQsIG5hbWUpXHJcbiAgICAgICAgICAgIGBcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAub3JkZXIoXCJuYW1lXCIpO1xyXG5cclxuICAgICAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgICByZXR1cm4gZGF0YTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCBcImxvYWRDaXRpZXNXaXRoWm9uaW5nc1wiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIENsZWFyIGNhY2hlXHJcbiAgY2xlYXJDYWNoZShwYXR0ZXJuKSB7XHJcbiAgICBpZiAocGF0dGVybikge1xyXG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLmNhY2hlLmtleXMoKSkge1xyXG4gICAgICAgIGlmIChrZXkuaW5jbHVkZXMocGF0dGVybikpIHtcclxuICAgICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBHZXQgY2FjaGUgc3RhdHNcclxuICBnZXRDYWNoZVN0YXRzKCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc2l6ZTogdGhpcy5jYWNoZS5zaXplLFxyXG4gICAgICBrZXlzOiBBcnJheS5mcm9tKHRoaXMuY2FjaGUua2V5cygpKSxcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXHJcbmV4cG9ydCBjb25zdCBhcGlTZXJ2aWNlID0gbmV3IEFwaVNlcnZpY2UoKTtcclxuIl0sIm5hbWVzIjpbImFwaVNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInRoaXMiLCJjYWNoZSIsIk1hcCIsImNhY2hlVGltZW91dCIsInJldHJ5QXR0ZW1wdHMiLCJyZXRyeURlbGF5Iiwid2l0aFJldHJ5Iiwib3BlcmF0aW9uIiwiYXR0ZW1wdHMiLCJpIiwiZXJyb3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJ3aXRoQ2FjaGUiLCJrZXkiLCJ0dGwiLCJjYWNoZWQiLCJnZXQiLCJEYXRlIiwibm93IiwidGltZXN0YW1wIiwiZGF0YSIsInNldCIsImhhbmRsZUVycm9yIiwiY29udGV4dCIsImNvbnNvbGUiLCJ1c2VyTWVzc2FnZSIsImNvZGUiLCJtZXNzYWdlIiwiaW5jbHVkZXMiLCJzZXRFcnJvciIsIkVycm9yIiwibG9hZENpdGllcyIsImFzeW5jIiwiZnJvbSIsInNlbGVjdCIsIm9yZGVyIiwibG9hZFpvbmluZ3MiLCJjaXR5SWQiLCJlcSIsImxvYWRab25lcyIsInpvbmluZ0lkIiwiZmluZERvY3VtZW50Iiwiem9uZUlkIiwidHlwb2xvZ2llSWQiLCJzaW5nbGUiLCJsb2FkQ2l0aWVzV2l0aFpvbmluZ3MiLCJjbGVhckNhY2hlIiwicGF0dGVybiIsImtleXMiLCJkZWxldGUiLCJjbGVhciIsImdldENhY2hlU3RhdHMiLCJzaXplIiwiQXJyYXkiXSwic291cmNlUm9vdCI6IiJ9