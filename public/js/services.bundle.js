"use strict";(self.webpackChunkurbandocs_webapp=self.webpackChunkurbandocs_webapp||[]).push([[671],{141:(e,t,r)=>{r.d(t,{K:()=>a});var n=r(9660),i=r(1235);const a=new class{constructor(){this.cache=new Map,this.cacheTimeout=12e4,this.retryAttempts=3,this.retryDelay=1e3}async withRetry(e,t=this.retryAttempts){for(let r=0;r<t;r++)try{return await e()}catch(e){if(r===t-1)throw e;await new Promise((e=>setTimeout(e,this.retryDelay*(r+1))))}}async withCache(e,t,r=this.cacheTimeout){const n=this.cache.get(e);if(n&&Date.now()-n.timestamp<r)return n.data;const i=await t();return this.cache.set(e,{data:i,timestamp:Date.now()}),i}handleError(e,t){console.error(`API Error in ${t}:`,e);let r="Une erreur inattendue s'est produite";throw"PGRST116"===e.code?r="Aucune donnée trouvée":"42P01"===e.code?r="Service temporairement indisponible":e.message?.includes("network")&&(r="Problème de connexion réseau"),i.n.setError({message:r,code:e.code}),new Error(r)}async loadCities(){try{return await this.withCache("cities",(async()=>await this.withRetry((async()=>{const{data:e,error:t}=await n.N.from("cities").select("id, name").order("name");if(t)throw t;return e}))))}catch(e){this.handleError(e,"loadCities")}}async loadZonings(e){if(!e)throw new Error("City ID is required");try{return await this.withCache(`zonings-${e}`,(async()=>await this.withRetry((async()=>{const{data:t,error:r}=await n.N.from("zonings").select("id, name").eq("city_id",e).order("name");if(r)throw r;return t}))))}catch(e){this.handleError(e,"loadZonings")}}async loadZones(e){if(!e)throw new Error("Zoning ID is required");try{return await this.withCache(`zones-${e}`,(async()=>await this.withRetry((async()=>{const{data:t,error:r}=await n.N.from("zones").select("id, name").eq("zoning_id",e).order("name");if(r)throw r;return t}))))}catch(e){this.handleError(e,"loadZones")}}async findDocument(e,t,r){if(!e||!t)throw new Error("Zoning ID and Zone ID are required");try{return await this.withRetry((async()=>{const{data:i,error:a}=await n.N.from("documents").select("\n            id,\n            html_content,\n            pdf_storage_path,\n            source_plu_date,\n            source_plu_url,\n            zoning:zonings(name, city:cities(name)),\n            zone:zones(name)\n          ").eq("zoning_id",e).eq("zone_id",t).eq("typology_id",r).single();if(a)throw a;return i}))}catch(e){this.handleError(e,"findDocument")}}async loadCitiesWithZonings(){try{return await this.withCache("cities-with-zonings",(async()=>await this.withRetry((async()=>{const{data:e,error:t}=await n.N.from("cities").select("\n              id,\n              name,\n              zonings(id, name)\n            ").order("name");if(t)throw t;return e}))))}catch(e){this.handleError(e,"loadCitiesWithZonings")}}clearCache(e){if(e)for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}}}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QixJQUMzQnlCLEtBQUssYUFDTEMsT0FDQywwT0FVREksR0FBRyxZQUFhRSxHQUNoQkYsR0FBRyxVQUFXSSxHQUNkSixHQUFHLGNBQWVLLEdBQ2xCQyxTQUVILEdBQUlwQyxFQUFPLE1BQU1BLEVBQ2pCLE9BQU9ZLElBRVgsQ0FBRSxNQUFPWixHQUNQVixLQUFLd0IsWUFBWWQsRUFBTyxlQUMxQixDQUNGLENBR0EsMkJBQU1xQyxHQUNKLElBQ0UsYUFBYS9DLEtBQUtjLFVBQVUsdUJBQXVCb0IsZUFDcENsQyxLQUFLTSxXQUFVNEIsVUFDMUIsTUFBTSxLQUFFWixFQUFJLE1BQUVaLFNBQWdCLElBQzNCeUIsS0FBSyxVQUNMQyxPQUNDLDJGQU1EQyxNQUFNLFFBRVQsR0FBSTNCLEVBQU8sTUFBTUEsRUFDakIsT0FBT1ksTUFHYixDQUFFLE1BQU9aLEdBQ1BWLEtBQUt3QixZQUFZZCxFQUFPLHdCQUMxQixDQUNGLENBR0EsVUFBQXNDLENBQVdDLEdBQ1QsR0FBSUEsRUFDRixJQUFLLE1BQU1sQyxLQUFPZixLQUFLQyxNQUFNaUQsT0FDdkJuQyxFQUFJZSxTQUFTbUIsSUFDZmpELEtBQUtDLE1BQU1rRCxPQUFPcEMsUUFJdEJmLEtBQUtDLE1BQU1tRCxPQUVmLENBR0EsYUFBQUMsR0FDRSxNQUFPLENBQ0xDLEtBQU10RCxLQUFLQyxNQUFNcUQsS0FDakJKLEtBQU1LLE1BQU1wQixLQUFLbkMsS0FBS0MsTUFBTWlELFFBRWhDLEUiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly91cmJhbmRvY3Nfd2ViYXBwLy4vc3JjL2pzL3NlcnZpY2VzL2FwaS1zZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRW5oYW5jZWQgQVBJIFNlcnZpY2VcbiAqIEBtb2R1bGUgYXBpLXNlcnZpY2VcbiAqIEBkZXNjcmlwdGlvbiBJbXByb3ZlZCBBUEkgc2VydmljZSB3aXRoIGNhY2hpbmcsIHJldHJ5IGxvZ2ljLCBhbmQgYmV0dGVyIGVycm9yIGhhbmRsaW5nXG4gKiBAdmVyc2lvbiAxLjAuMFxuICogQGF1dGhvciBHcmV5UGFuZGFcbiAqL1xuXG5pbXBvcnQgeyBzdXBhYmFzZSB9IGZyb20gXCIuLi9zdXBhYmFzZS1jbGllbnQuanNcIjtcbmltcG9ydCB7IHN0YXRlTWFuYWdlciB9IGZyb20gXCIuLi9zdGF0ZS9zdGF0ZS1tYW5hZ2VyLmpzXCI7XG5cbmNsYXNzIEFwaVNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmNhY2hlID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuY2FjaGVUaW1lb3V0ID0gMiAqIDYwICogMTAwMDsgLy8gMiBtaW51dGVzXG4gICAgdGhpcy5yZXRyeUF0dGVtcHRzID0gMztcbiAgICB0aGlzLnJldHJ5RGVsYXkgPSAxMDAwOyAvLyAxIHNlY29uZFxuICB9XG5cbiAgLy8gR2VuZXJpYyByZXRyeSB3cmFwcGVyXG4gIGFzeW5jIHdpdGhSZXRyeShvcGVyYXRpb24sIGF0dGVtcHRzID0gdGhpcy5yZXRyeUF0dGVtcHRzKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdHRlbXB0czsgaSsrKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9uKCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoaSA9PT0gYXR0ZW1wdHMgLSAxKSB0aHJvdyBlcnJvcjtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+XG4gICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCB0aGlzLnJldHJ5RGVsYXkgKiAoaSArIDEpKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIENhY2hlIHdyYXBwZXJcbiAgYXN5bmMgd2l0aENhY2hlKGtleSwgb3BlcmF0aW9uLCB0dGwgPSB0aGlzLmNhY2hlVGltZW91dCkge1xuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgaWYgKGNhY2hlZCAmJiBEYXRlLm5vdygpIC0gY2FjaGVkLnRpbWVzdGFtcCA8IHR0bCkge1xuICAgICAgcmV0dXJuIGNhY2hlZC5kYXRhO1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBvcGVyYXRpb24oKTtcbiAgICB0aGlzLmNhY2hlLnNldChrZXksIHsgZGF0YSwgdGltZXN0YW1wOiBEYXRlLm5vdygpIH0pO1xuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgLy8gRW5oYW5jZWQgZXJyb3IgaGFuZGxpbmdcbiAgaGFuZGxlRXJyb3IoZXJyb3IsIGNvbnRleHQpIHtcbiAgICBjb25zb2xlLmVycm9yKGBBUEkgRXJyb3IgaW4gJHtjb250ZXh0fTpgLCBlcnJvcik7XG5cbiAgICBsZXQgdXNlck1lc3NhZ2UgPSBcIlVuZSBlcnJldXIgaW5hdHRlbmR1ZSBzJ2VzdCBwcm9kdWl0ZVwiO1xuXG4gICAgaWYgKGVycm9yLmNvZGUgPT09IFwiUEdSU1QxMTZcIikge1xuICAgICAgdXNlck1lc3NhZ2UgPSBcIkF1Y3VuZSBkb25uw6llIHRyb3V2w6llXCI7XG4gICAgfSBlbHNlIGlmIChlcnJvci5jb2RlID09PSBcIjQyUDAxXCIpIHtcbiAgICAgIHVzZXJNZXNzYWdlID0gXCJTZXJ2aWNlIHRlbXBvcmFpcmVtZW50IGluZGlzcG9uaWJsZVwiO1xuICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZT8uaW5jbHVkZXMoXCJuZXR3b3JrXCIpKSB7XG4gICAgICB1c2VyTWVzc2FnZSA9IFwiUHJvYmzDqG1lIGRlIGNvbm5leGlvbiByw6lzZWF1XCI7XG4gICAgfVxuXG4gICAgc3RhdGVNYW5hZ2VyLnNldEVycm9yKHsgbWVzc2FnZTogdXNlck1lc3NhZ2UsIGNvZGU6IGVycm9yLmNvZGUgfSk7XG4gICAgdGhyb3cgbmV3IEVycm9yKHVzZXJNZXNzYWdlKTtcbiAgfVxuXG4gIC8vIE9wdGltaXplZCBjaXR5IGxvYWRpbmcgd2l0aCBjYWNoaW5nXG4gIGFzeW5jIGxvYWRDaXRpZXMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhDYWNoZShcImNpdGllc1wiLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhSZXRyeShhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgICAgICAgIC5mcm9tKFwiY2l0aWVzXCIpXG4gICAgICAgICAgICAuc2VsZWN0KFwiaWQsIG5hbWVcIilcbiAgICAgICAgICAgIC5vcmRlcihcIm5hbWVcIik7XG5cbiAgICAgICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xuICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCBcImxvYWRDaXRpZXNcIik7XG4gICAgfVxuICB9XG5cbiAgLy8gT3B0aW1pemVkIHpvbmluZyBsb2FkaW5nXG4gIGFzeW5jIGxvYWRab25pbmdzKGNpdHlJZCkge1xuICAgIGlmICghY2l0eUlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDaXR5IElEIGlzIHJlcXVpcmVkXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy53aXRoQ2FjaGUoYHpvbmluZ3MtJHtjaXR5SWR9YCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy53aXRoUmV0cnkoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgICAgICAuZnJvbShcInpvbmluZ3NcIilcbiAgICAgICAgICAgIC5zZWxlY3QoXCJpZCwgbmFtZVwiKVxuICAgICAgICAgICAgLmVxKFwiY2l0eV9pZFwiLCBjaXR5SWQpXG4gICAgICAgICAgICAub3JkZXIoXCJuYW1lXCIpO1xuXG4gICAgICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgXCJsb2FkWm9uaW5nc1wiKTtcbiAgICB9XG4gIH1cblxuICAvLyBPcHRpbWl6ZWQgem9uZSBsb2FkaW5nXG4gIGFzeW5jIGxvYWRab25lcyh6b25pbmdJZCkge1xuICAgIGlmICghem9uaW5nSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlpvbmluZyBJRCBpcyByZXF1aXJlZFwiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aENhY2hlKGB6b25lcy0ke3pvbmluZ0lkfWAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aFJldHJ5KGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAgICAgLmZyb20oXCJ6b25lc1wiKVxuICAgICAgICAgICAgLnNlbGVjdChcImlkLCBuYW1lXCIpXG4gICAgICAgICAgICAuZXEoXCJ6b25pbmdfaWRcIiwgem9uaW5nSWQpXG4gICAgICAgICAgICAub3JkZXIoXCJuYW1lXCIpO1xuXG4gICAgICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgXCJsb2FkWm9uZXNcIik7XG4gICAgfVxuICB9XG5cbiAgLy8gRW5oYW5jZWQgZG9jdW1lbnQgc2VhcmNoXG4gIGFzeW5jIGZpbmREb2N1bWVudCh6b25pbmdJZCwgem9uZUlkLCB0eXBvbG9naWVJZCkge1xuICAgIGlmICghem9uaW5nSWQgfHwgIXpvbmVJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiWm9uaW5nIElEIGFuZCBab25lIElEIGFyZSByZXF1aXJlZFwiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aFJldHJ5KGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgICAgICAuZnJvbShcImRvY3VtZW50c1wiKVxuICAgICAgICAgIC5zZWxlY3QoXG4gICAgICAgICAgICBgXG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIGh0bWxfY29udGVudCxcbiAgICAgICAgICAgIHBkZl9zdG9yYWdlX3BhdGgsXG4gICAgICAgICAgICBzb3VyY2VfcGx1X2RhdGUsXG4gICAgICAgICAgICBzb3VyY2VfcGx1X3VybCxcbiAgICAgICAgICAgIHpvbmluZzp6b25pbmdzKG5hbWUsIGNpdHk6Y2l0aWVzKG5hbWUpKSxcbiAgICAgICAgICAgIHpvbmU6em9uZXMobmFtZSlcbiAgICAgICAgICBgXG4gICAgICAgICAgKVxuICAgICAgICAgIC5lcShcInpvbmluZ19pZFwiLCB6b25pbmdJZClcbiAgICAgICAgICAuZXEoXCJ6b25lX2lkXCIsIHpvbmVJZClcbiAgICAgICAgICAuZXEoXCJ0eXBvbG9neV9pZFwiLCB0eXBvbG9naWVJZClcbiAgICAgICAgICAuc2luZ2xlKCk7XG5cbiAgICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgXCJmaW5kRG9jdW1lbnRcIik7XG4gICAgfVxuICB9XG5cbiAgLy8gQmF0Y2ggbG9hZGluZyBmb3IgYmV0dGVyIHBlcmZvcm1hbmNlXG4gIGFzeW5jIGxvYWRDaXRpZXNXaXRoWm9uaW5ncygpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMud2l0aENhY2hlKFwiY2l0aWVzLXdpdGgtem9uaW5nc1wiLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLndpdGhSZXRyeShhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgICAgICAgIC5mcm9tKFwiY2l0aWVzXCIpXG4gICAgICAgICAgICAuc2VsZWN0KFxuICAgICAgICAgICAgICBgXG4gICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICB6b25pbmdzKGlkLCBuYW1lKVxuICAgICAgICAgICAgYFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLm9yZGVyKFwibmFtZVwiKTtcblxuICAgICAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IsIFwibG9hZENpdGllc1dpdGhab25pbmdzXCIpO1xuICAgIH1cbiAgfVxuXG4gIC8vIENsZWFyIGNhY2hlXG4gIGNsZWFyQ2FjaGUocGF0dGVybikge1xuICAgIGlmIChwYXR0ZXJuKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiB0aGlzLmNhY2hlLmtleXMoKSkge1xuICAgICAgICBpZiAoa2V5LmluY2x1ZGVzKHBhdHRlcm4pKSB7XG4gICAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgLy8gR2V0IGNhY2hlIHN0YXRzXG4gIGdldENhY2hlU3RhdHMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNpemU6IHRoaXMuY2FjaGUuc2l6ZSxcbiAgICAgIGtleXM6IEFycmF5LmZyb20odGhpcy5jYWNoZS5rZXlzKCkpLFxuICAgIH07XG4gIH1cbn1cblxuLy8gRXhwb3J0IHNpbmdsZXRvbiBpbnN0YW5jZVxuZXhwb3J0IGNvbnN0IGFwaVNlcnZpY2UgPSBuZXcgQXBpU2VydmljZSgpO1xuIl0sIm5hbWVzIjpbImFwaVNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInRoaXMiLCJjYWNoZSIsIk1hcCIsImNhY2hlVGltZW91dCIsInJldHJ5QXR0ZW1wdHMiLCJyZXRyeURlbGF5Iiwid2l0aFJldHJ5Iiwib3BlcmF0aW9uIiwiYXR0ZW1wdHMiLCJpIiwiZXJyb3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJ3aXRoQ2FjaGUiLCJrZXkiLCJ0dGwiLCJjYWNoZWQiLCJnZXQiLCJEYXRlIiwibm93IiwidGltZXN0YW1wIiwiZGF0YSIsInNldCIsImhhbmRsZUVycm9yIiwiY29udGV4dCIsImNvbnNvbGUiLCJ1c2VyTWVzc2FnZSIsImNvZGUiLCJtZXNzYWdlIiwiaW5jbHVkZXMiLCJzZXRFcnJvciIsIkVycm9yIiwibG9hZENpdGllcyIsImFzeW5jIiwiZnJvbSIsInNlbGVjdCIsIm9yZGVyIiwibG9hZFpvbmluZ3MiLCJjaXR5SWQiLCJlcSIsImxvYWRab25lcyIsInpvbmluZ0lkIiwiZmluZERvY3VtZW50Iiwiem9uZUlkIiwidHlwb2xvZ2llSWQiLCJzaW5nbGUiLCJsb2FkQ2l0aWVzV2l0aFpvbmluZ3MiLCJjbGVhckNhY2hlIiwicGF0dGVybiIsImtleXMiLCJkZWxldGUiLCJjbGVhciIsImdldENhY2hlU3RhdHMiLCJzaXplIiwiQXJyYXkiXSwic291cmNlUm9vdCI6IiJ9